{% extends 'inventory/base.html' %}
{% load custom_filters %}

{% block title %}Dashboard{% endblock %}
{% block extra_head %}{% endblock %}

{% block content %}
<section class="hero-card mb-4">
  <div class="row align-items-center g-3">
    <div class="col-lg-5">
      <h1 class="mb-1">Your Diecast Collection</h1>
      <p class="text-muted mb-2 small">Modern overview of your portfolio with insights and trends.</p>
      <div class="quick-actions d-flex gap-2 flex-wrap">
        <a href="{% url 'car_create' %}" class="btn btn-sm btn-primary">
          <i class="bi bi-plus-circle me-1"></i>Add New Car
        </a>
        <a href="{% url 'profile' %}" class="btn btn-sm btn-outline-primary">
          <i class="bi bi-person-circle me-1"></i>Profile
        </a>
        <a href="{% url 'export_collection_csv' %}" class="btn btn-sm btn-outline-success" title="Export collection to CSV">
          <i class="bi bi-download me-1"></i>Export CSV
        </a>
        <button onclick="window.print()" class="btn btn-sm btn-outline-secondary" title="Print collection">
          <i class="bi bi-printer me-1"></i>Print
        </button>
      </div>
    </div>
    <div class="col-lg-7">
      <div class="row g-2">
        <div class="col-6 col-md-3" data-aos="fade-up" data-aos-delay="0">
          <div class="metric-card d-flex align-items-center">
            <i class="bi bi-wallet2 text-warning metric-icon"></i>
            <div>
              <div class="metric-label">Collection Value</div>
              <div class="metric-value"><span class="counter-value" data-count="{{ total_value }}">0</span></div>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-3" data-aos="fade-up" data-aos-delay="100">
          <div class="metric-card d-flex align-items-center">
            <i class="bi bi-car-front text-primary metric-icon"></i>
            <div>
              <div class="metric-label">Total Cars</div>
              <div class="metric-value"><span class="counter-value" data-count="{{ total_cars }}">0</span></div>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-3" data-aos="fade-up" data-aos-delay="200">
          <div class="metric-card d-flex align-items-center">
            <i class="bi bi-cash-stack text-success metric-icon"></i>
            <div>
              <div class="metric-label">Total Spent</div>
              <div class="metric-value"><span class="counter-value" data-count="{{ total_spent }}">0</span></div>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-3" data-aos="fade-up" data-aos-delay="300">
          <div class="metric-card d-flex align-items-center">
            <i class="bi bi-graph-up text-info metric-icon"></i>
            <div>
              <div class="metric-label">Avg. Price</div>
              <div class="metric-value"><span class="counter-value" data-count="{{ avg_price }}">0</span></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Enhanced Notification Banner - Dashboard Only -->
{% include 'inventory/components/notification_banner.html' %}

<div class="row mb-4">
    <div class="col-md-4" data-aos="fade-right">
        <!-- Collection Stats -->
        <div class="dashboard-stats card card-premium mb-3">
            <div class="card-header bg-primary text-white py-2">
                <h6 class="mb-0">Collection Overview</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6 mb-3">
                        <h6 class="text-muted mb-1">Collection Value</h6>
                        <h3 class="text-primary mb-0">₹{{ total_value|floatformat:2 }}</h3>
                    </div>
                    <div class="col-6 mb-3">
                        <h6 class="text-muted mb-1">Total Cars</h6>
                        <h3 class="text-success mb-0">{{ total_cars }}</h3>
                    </div>
                    <div class="col-6">
                        <h6 class="text-muted mb-1">Total Spent</h6>
                        <h5 class="mb-0">₹{{ total_spent|floatformat:2 }}</h5>
                    </div>
                    <div class="col-6">
                        <h6 class="text-muted mb-1">Avg. Price</h6>
                        <h5 class="mb-0">₹{{ avg_price|floatformat:2 }}</h5>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Market Portfolio -->
        <div class="card card-premium mb-3">
            <div class="card-header bg-success text-white py-2">
                <h6 class="mb-0">Market Portfolio Value</h6>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-12 mb-2">
                        <h6 class="text-muted mb-1">Total Portfolio Value</h6>
                        <h3 class="text-success mb-0">₹{{ market_current_total|floatformat:2 }}</h3>
                        <small class="text-muted">
                            {% if cars_with_market_data > 0 and cars_without_market_data > 0 %}
                                {{ cars_with_market_data }} with market data + {{ cars_without_market_data }} using purchase price
                            {% elif cars_with_market_data > 0 %}
                                All {{ cars_with_market_data }} car{{ cars_with_market_data|pluralize }} with market data
                            {% elif cars_without_market_data > 0 %}
                                All {{ cars_without_market_data }} car{{ cars_without_market_data|pluralize }} using purchase price
                            {% endif %}
                        </small>
                    </div>
                    <div class="col-12 mb-2">
                        <h6 class="text-muted mb-1">Original Purchase Value</h6>
                        <h4 class="text-primary mb-0">₹{{ purchase_portfolio_value|floatformat:2 }}</h4>
                    </div>
                </div>
                
                {% if portfolio_gain_loss_pct is not None %}
                <div class="alert {% if portfolio_gain_loss >= 0 %}alert-success{% else %}alert-danger{% endif %} py-2 mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>Net Gain/Loss:</strong>
                            <span class="ms-2">
                                {% if portfolio_gain_loss >= 0 %}
                                    <i class="bi bi-arrow-up-right me-1"></i>+₹{{ portfolio_gain_loss|floatformat:2 }}
                                {% else %}
                                    <i class="bi bi-arrow-down-right me-1"></i>₹{{ portfolio_gain_loss|floatformat:2 }}
                                {% endif %}
                            </span>
                        </div>
                        <div>
                            <span class="badge {% if portfolio_gain_loss >= 0 %}bg-success{% else %}bg-danger{% endif %} fs-6">
                                {% if portfolio_gain_loss >= 0 %}+{% endif %}{{ portfolio_gain_loss_pct }}%
                            </span>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                {% if cars_without_market_data > 0 %}
                <div class="alert alert-info py-2 mb-3">
                    <small><i class="bi bi-info-circle me-1"></i>{{ cars_without_market_data }} car{{ cars_without_market_data|pluralize }} valued at purchase price (fetch market data for updated valuation)</small>
                </div>
                {% endif %}
                
                {% if market_change_pct is not None %}
                <div class="row">
                    <div class="col-12">
                        <h6 class="text-muted mb-1">Market Change (30d)</h6>
                        <h5 class="mb-0 {% if market_change_pct >= 0 %}text-success{% else %}text-danger{% endif %}">
                            {% if market_change_pct >= 0 %}
                                <i class="bi bi-arrow-up-right me-1"></i>
                            {% else %}
                                <i class="bi bi-arrow-down-right me-1"></i>
                            {% endif %}
                            {{ market_change_pct }}%
                        </h5>
                    </div>
                </div>
                {% endif %}
                {% if top_price_changes %}
                <hr>
                <h6 class="text-muted">Top Price Changes vs Purchase</h6>
                <div class="d-flex flex-wrap gap-2">
                    {% for item in top_price_changes %}
                        <a class="chip text-decoration-none" href="{% url 'car_detail' item.car.pk %}">
                            <i class="bi bi-graph-up"></i>
                            <span class="fw-semibold">{{ item.car.model_name }}</span>
                            <span class="text-success fw-semibold">+{{ item.change_pct }}%</span>
                            <span class="muted">₹{{ item.latest_price|floatformat:2 }}</span>
                        </a>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Status Distribution -->
        <div class="card card-premium mb-3">
            <div class="card-header bg-primary text-white py-2 d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Status Distribution</h6>
                <span class="badge bg-light text-dark">Overview</span>
            </div>
            <div class="card-body">
                <div class="chart-box mb-3">
                    <canvas id="statusChart"></canvas>
                </div>
                <div class="row row-cols-2 g-2">
                    <div class="col"><span class="badge bg-info">Purchased/Paid</span> {{ status_stats|get_item:'Purchased/Paid'|default:0 }}</div>
                    <div class="col"><span class="badge bg-warning">Shipped</span> {{ status_stats|get_item:'Shipped'|default:0 }}</div>
                    <div class="col"><span class="badge bg-success">Delivered</span> {{ status_stats|get_item:'Delivered'|default:0 }}</div>
                    <div class="col"><span class="badge bg-danger">Overdue</span> {{ status_stats|get_item:'Overdue'|default:0 }}</div>
                    <div class="col"><span class="badge bg-primary">Pre-Order</span> {{ status_stats|get_item:'Pre-Order'|default:0 }}</div>
                    <div class="col"><span class="badge bg-secondary">Commented Sold</span> {{ status_stats|get_item:'Commented Sold'|default:0 }}</div>
                </div>
            </div>
        </div>
        
        <!-- Monthly Activity - Compact -->
        <div class="card card-premium">
            <div class="card-header bg-primary text-white py-2">
                <h6 class="mb-0">Monthly Activity</h6>
            </div>
            <div class="card-body">
                <h6 class="text-muted mb-1">Cars purchased this month</h6>
                <h3 class="text-primary mb-0">{{ cars_this_month }}</h3>
            </div>
        </div>
    </div>
    
    <div class="col-md-8" data-aos="fade-left">
        <!-- Portfolio Valuation & Seller Ratings Row -->
        <div class="row mb-3">
            <!-- Portfolio Valuation -->
            <div class="col-lg-8 mb-3">
                <div class="card card-premium h-100">
                    <div class="card-header bg-info text-white py-2">
                        <h6 class="mb-0">Portfolio Valuation</h6>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small mb-3">Calculate portfolio value using existing market data and purchase prices (no new data fetching).</p>
                        <button id="calculate-portfolio-btn" class="btn btn-primary">
                            <i class="bi bi-calculator me-2"></i>Calculate Portfolio Value
                        </button>
                        <div id="portfolio-results-container" class="mt-3 d-none">
                            <div id="portfolio-spinner" class="d-none">
                                {% include 'inventory/components/loading_spinner.html' with message='Calculating your portfolio value...' %}
                            </div>
                            <div id="portfolio-results"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Seller Ratings -->
            <div class="col-lg-4 mb-3">
                <div class="card card-premium h-100">
                    <div class="card-header bg-primary text-white py-2">
                        <h6 class="mb-0">Seller Ratings</h6>
                    </div>
                    <div class="card-body p-0">
                        <div style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm table-hover mb-0">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th class="small">Seller</th>
                                        <th class="text-end small">Rating</th>
                                    </tr>
                                </thead>
                                <tbody class="small">
                                    {% for seller, data in seller_ratings.items %}
                                    <tr class="{% if data.has_overdue %}table-danger fw-semibold{% endif %}">
                                        <td>{{ seller }} {% if data.has_overdue %}<span class="badge bg-danger ms-1">Overdue</span>{% endif %}</td>
                                        <td class="text-end"><span class="fw-semibold">{{ data.avg_rating }}</span> <i class="bi bi-star-fill text-warning"></i> <span class="text-muted">({{ data.total_ratings }})</span></td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="2" class="text-center">No ratings yet</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Manufacturers & Scales -->  
        <div class="card card-premium mb-3">
            <div class="card-header bg-primary text-white py-2">
                <h6 class="mb-0">Collection Insights</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Top Manufacturers -->
                    <div class="col-md-6">
                        <h6 class="text-muted mb-3">Top Manufacturers</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead class="table-light">
                                    <tr>
                                        <th>Manufacturer</th>
                                        <th class="text-end">Count</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in top_manufacturers %}
                                    <tr>
                                        <td>{{ item.manufacturer }}</td>
                                        <td class="text-end">{{ item.count }}</td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="2" class="text-center">No data available</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Most Common Scales -->
                    <div class="col-md-6">
                        <h6 class="text-muted mb-3">Most Common Scales</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead class="table-light">
                                    <tr>
                                        <th>Scale</th>
                                        <th class="text-end">Count</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in scale_counts %}
                                    <tr>
                                        <td>{{ item.scale }}</td>
                                        <td class="text-end">{{ item.count }}</td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="2" class="text-center">No data available</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Monthly Purchase Trends -->
                {% if has_trend_data %}
                <div class="mt-4">
                    <h6 class="text-muted mb-3">Monthly Purchase Trends</h6>
                    <div class="chart-box"><canvas id="purchaseChart"></canvas></div>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Filter & Sort -->
        <div class="card card-premium" data-aos="fade-up">
            <div class="card-header bg-light collapse-trigger" id="filter-header" data-bs-toggle="collapse" data-bs-target="#filter-collapse" aria-expanded="true">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><i class="bi bi-funnel me-2"></i>Filter & Sort</h6>
                    <i class="bi bi-chevron-down"></i>
                </div>
            </div>
            <div class="collapse show" id="filter-collapse">
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-md-4">
                        <label for="status" class="form-label">Status</label>
                        <select class="form-select" id="status" name="status">
                            <option value="">All Statuses</option>
                            {% for status_value, status_label in status_choices %}
                                <option value="{{ status_value }}" {% if selected_status == status_value %}selected{% endif %}>{{ status_label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="manufacturer" class="form-label">Manufacturer</label>
                        <select class="form-select" id="manufacturer" name="manufacturer">
                            <option value="">All Manufacturers</option>
                            {% for manufacturer in manufacturers %}
                                <option value="{{ manufacturer }}" {% if selected_manufacturer == manufacturer %}selected{% endif %}>{{ manufacturer }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="sort_by" class="form-label">Sort By</label>
                        <select class="form-select" id="sort_by" name="sort_by">
                            <option value="-purchase_date" {% if selected_sort == '-purchase_date' %}selected{% endif %}>Purchase Date (Newest)</option>
                            <option value="purchase_date" {% if selected_sort == 'purchase_date' %}selected{% endif %}>Purchase Date (Oldest)</option>
                            <option value="-price" {% if selected_sort == '-price' %}selected{% endif %}>Price (High to Low)</option>
                            <option value="price" {% if selected_sort == 'price' %}selected{% endif %}>Price (Low to High)</option>
                            <option value="manufacturer" {% if selected_sort == 'manufacturer' %}selected{% endif %}>Manufacturer (A-Z)</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">Apply Filters</button>
                        <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">Clear Filters</a>
                    </div>
                </form>
            </div>
            </div>
        </div>
    </div>
</div>

<!-- Floating Action Button - Scroll to Top -->
<button id="scroll-top-btn" class="fab d-none" title="Scroll to top">
    <i class="bi bi-arrow-up"></i>
</button>

{% if cars %}
<div class="row" data-aos="fade-up">
    <div class="col-md-12">
    <div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
        <thead class="table-dark">
            <tr>
                <th>Image</th>
                <th>Model</th>
                <th>Manufacturer</th>
                <th class="d-none d-md-table-cell">Scale</th>
                <th>Price</th>
                <th class="d-none d-lg-table-cell">Shipping</th>
                <th class="d-none d-lg-table-cell">Advance</th>
                <th class="d-none d-lg-table-cell">Remaining</th>
                <th class="d-none d-md-table-cell">Purchase Date</th>
                <th class="d-none d-md-table-cell">Delivery Due</th>
                <th class="d-none d-lg-table-cell">Delivered Date</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for car in cars %}
            <tr>
                <td>
                    {% if car.image %}
                        <a href="{% url 'car_detail' car.pk %}" class="car-image-link">
                            <div class="car-image-wrapper" style="width: 60px; height: 60px;">
                                <img src="{{ car.image.url }}" alt="{{ car.model_name }}" class="car-image-hover img-thumbnail thumb-60">
                            </div>
                        </a>
                    {% else %}
                        <div class="text-center"><i class="bi bi-image text-muted fs-2"></i></div>
                    {% endif %}
                </td>
                <td>{{ car.model_name }}</td>
                <td>{{ car.manufacturer }}</td>
                <td class="d-none d-md-table-cell"><span class="badge bg-secondary">{{ car.scale }}</span></td>
                <td>₹{{ car.price }}</td>
                <td class="d-none d-lg-table-cell">₹{{ car.shipping_cost }}</td>
                <td class="d-none d-lg-table-cell">₹{{ car.advance_payment }}</td>
                <td class="d-none d-lg-table-cell">₹{{ car.remaining_payment }}</td>
                <td class="d-none d-md-table-cell">{{ car.purchase_date }}</td>
                <td class="d-none d-md-table-cell">{{ car.delivery_due_date }}</td>
                <td class="d-none d-lg-table-cell">{% if car.delivered_date %}{{ car.delivered_date }}{% else %}<span class="text-muted">Not yet</span>{% endif %}</td>
                <td>
                    <span class="badge {% if car.status == 'Purchased/Paid' %}bg-info{% elif car.status == 'Shipped' %}bg-warning{% elif car.status == 'Delivered' %}bg-success{% elif car.status == 'Overdue' %}bg-danger{% elif car.status == 'Pre-Order' %}bg-primary{% elif car.status == 'Commented Sold' %}bg-secondary{% endif %} rounded-pill">
                        {% if car.status == 'Purchased/Paid' %}<i class="bi bi-wallet2 me-1"></i>{% elif car.status == 'Shipped' %}<i class="bi bi-box-seam me-1"></i>{% elif car.status == 'Delivered' %}<i class="bi bi-truck me-1"></i>{% elif car.status == 'Overdue' %}<i class="bi bi-exclamation-octagon me-1"></i>{% elif car.status == 'Pre-Order' %}<i class="bi bi-clock-history me-1"></i>{% elif car.status == 'Commented Sold' %}<i class="bi bi-chat-dots me-1"></i>{% endif %}
                        {{ car.status }}
                    </span>
                </td>
                <td>
                    <a href="{% url 'car_detail' car.pk %}" class="btn btn-sm btn-primary">View</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
    </div>
</div>
{% else %}
{% include 'inventory/components/empty_state.html' with icon='bi-car-front-fill' title='No Cars in Your Collection Yet' message='Start building your dream diecast collection today! Track values, manage deliveries, and showcase your prized models.' cta_text='Add Your First Car' cta_url='car_create' %}
{% endif %}

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Animated Counter for Dashboard Metrics
    document.querySelectorAll('.counter-value').forEach(counter => {
        const target = parseFloat(counter.getAttribute('data-count'));
        if (isNaN(target)) return;
        
        const decimals = target % 1 !== 0 ? 2 : 0;
        const prefix = '₹';
        
        // Check if it's a currency value (contains rupee symbol in parent)
        const isCurrency = counter.closest('.metric-value').textContent.includes('₹') || 
                          counter.parentElement.parentElement.querySelector('.metric-label').textContent.includes('Value') ||
                          counter.parentElement.parentElement.querySelector('.metric-label').textContent.includes('Spent') ||
                          counter.parentElement.parentElement.querySelector('.metric-label').textContent.includes('Price');
        
        const options = {
            useEasing: true,
            useGrouping: true,
            separator: ',',
            decimal: '.',
            prefix: isCurrency ? prefix : '',
            suffix: ''
        };
        
        const countUp = new CountUp(counter, 0, target, decimals, 2, options);
        
        if (!countUp.error) {
            countUp.start();
        } else {
            counter.textContent = isCurrency ? prefix + target.toFixed(decimals) : target;
        }
    });

    // Scroll to Top Button
    const scrollTopBtn = document.getElementById('scroll-top-btn');
    if (scrollTopBtn) {
        window.addEventListener('scroll', function() {
            if (window.pageYOffset > 300) {
                scrollTopBtn.classList.remove('d-none');
            } else {
                scrollTopBtn.classList.add('d-none');
            }
        });

        scrollTopBtn.addEventListener('click', function() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });
    }

    // Collapsible Section Icon Rotation
    const collapseElements = document.querySelectorAll('[data-bs-toggle="collapse"]');
    collapseElements.forEach(element => {
        const target = document.querySelector(element.getAttribute('data-bs-target'));
        if (target) {
            target.addEventListener('show.bs.collapse', function() {
                const icon = element.querySelector('.bi-chevron-down');
                if (icon) icon.style.transform = 'rotate(180deg)';
            });
            target.addEventListener('hide.bs.collapse', function() {
                const icon = element.querySelector('.bi-chevron-down');
                if (icon) icon.style.transform = 'rotate(0deg)';
            });
        }
    });
    // Portfolio valuation logic
    const calculateBtn = document.getElementById('calculate-portfolio-btn');
    const resultsContainer = document.getElementById('portfolio-results-container');
    const spinner = document.getElementById('portfolio-spinner');
    const resultsDiv = document.getElementById('portfolio-results');

    if(calculateBtn) {
        calculateBtn.addEventListener('click', function() {
            resultsContainer.classList.remove('d-none');
            spinner.classList.remove('d-none');
            resultsDiv.innerHTML = '';
            calculateBtn.disabled = true;

            const valuationUrl = "{% url 'calculate_portfolio_valuation' %}";
            fetch(valuationUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP error! status: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    spinner.classList.add('d-none');
                    let content = `<h5>Total Portfolio Value: <span class="text-success">₹${data.total_portfolio_value_inr}</span></h5>`;
                    
                    // Summary statistics
                    content += '<div class="row text-center mt-3 mb-3">';
                    content += `<div class="col-4"><small class="text-muted">Market Data</small><br><strong class="text-info">${data.cars_with_market_data}</strong></div>`;
                    content += `<div class="col-4"><small class="text-muted">Purchase Price</small><br><strong class="text-warning">${data.cars_with_purchase_price}</strong></div>`;
                    content += `<div class="col-4"><small class="text-muted">No Price</small><br><strong class="text-danger">${data.cars_without_any_price}</strong></div>`;
                    content += '</div>';
                    
                    content += `<p class="mb-2"><small class="text-muted">Total Cars: ${data.total_cars}</small></p>`;
                    
                    if(data.results && data.results.length > 0) {
                        content += '<div class="mt-3">';
                        content += '<div class="table-responsive" style="max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem;">';
                        content += '<table class="table table-sm table-striped mb-0">';
                        content += '<thead class="table-light sticky-top"><tr><th>Car</th><th>Value</th><th>Source</th></tr></thead>';
                        content += '<tbody>';
                        data.results.forEach(item => {
                            let sourceClass = '';
                            if (item.value_source.includes('Market Data')) {
                                sourceClass = 'text-info';
                            } else if (item.value_source === 'Purchase Price') {
                                sourceClass = 'text-warning';
                            } else {
                                sourceClass = 'text-danger';
                            }
                            
                            content += `<tr>`;
                            content += `<td><strong>${item.model_name}</strong><br><small class="text-muted">${item.manufacturer}</small></td>`;
                            content += `<td>₹${item.value_inr}</td>`;
                            content += `<td><span class="${sourceClass}">${item.value_source}</span>`;
                            if (item.market_data_date) {
                                const date = new Date(item.market_data_date);
                                content += `<br><small class="text-muted">${date.toLocaleDateString()}</small>`;
                            }
                            content += `</td>`;
                            content += `</tr>`;
                        });
                        content += '</tbody></table>';
                        content += '</div>';
                        content += '</div>';
                    }
                    resultsDiv.innerHTML = content;
                })
                .catch(error => {
                    spinner.classList.add('d-none');
                    resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
                })
                .finally(() => {
                    calculateBtn.disabled = false;
                });
        });
    }

    // Charts: Monthly Purchase Trends (no Django tags in JS)
    const pCanvas = document.getElementById('purchaseChart');
    if (pCanvas) {
        const pctx = pCanvas.getContext('2d');
        let months = [];
        let purchaseCounts = [];
        try {
            months = JSON.parse('{{ months|escapejs }}');
            purchaseCounts = JSON.parse('{{ purchase_counts|escapejs }}');
        } catch (e) {
            months = [];
            purchaseCounts = [];
        }
        if (Array.isArray(months) && months.length > 0) {
            const gradient = pctx.createLinearGradient(0, 0, 0, 220);
            gradient.addColorStop(0, 'rgba(99,102,241,0.35)');
            gradient.addColorStop(1, 'rgba(99,102,241,0.05)');

            const gridColor = 'rgba(0,0,0,0.06)';
            const tickColor = '#0f172a';
            const legendLabelColor = tickColor;

            new Chart(pctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Cars Purchased',
                        data: purchaseCounts,
                        backgroundColor: gradient,
                        borderColor: 'rgba(99,102,241,0.9)',
                        borderWidth: 1,
                        barThickness: 'flex',
                        maxBarThickness: 28
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false, labels: { color: legendLabelColor } },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    elements: { bar: { borderRadius: 6 } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { precision: 0, color: tickColor },
                            grid: { color: gridColor }
                        },
                        x: { grid: { display: false }, ticks: { color: tickColor } }
                    }
                }
            });
        }
    }

    // Status donut chart (parse JSON from context to avoid Django tags in JS)
    const sctx = document.getElementById('statusChart');
    if (sctx) {
        let statusStats = {};
        try {
            statusStats = JSON.parse('{{ status_stats_json|escapejs }}');
        } catch (e) { statusStats = {}; }
        const legendColor = '#0f172a';
        new Chart(sctx, {
            type: 'doughnut',
            data: {
                labels: ['Purchased/Paid','Shipped','Delivered','Overdue','Pre-Order','Commented Sold'],
                datasets: [{
                    data: [
                        (statusStats['Purchased/Paid'] || 0),
                        (statusStats['Shipped'] || 0),
                        (statusStats['Delivered'] || 0),
                        (statusStats['Overdue'] || 0),
                        (statusStats['Pre-Order'] || 0),
                        (statusStats['Commented Sold'] || 0)
                    ],
                    backgroundColor: [
                        'rgba(13,110,253,0.70)',
                        'rgba(255,193,7,0.70)',
                        'rgba(25,135,84,0.70)',
                        'rgba(220,53,69,0.70)',
                        'rgba(13,110,253,0.40)',
                        'rgba(108,117,125,0.70)'
                    ],
                    borderColor: [
                        'rgba(13,110,253,1)',
                        'rgba(255,193,7,1)',
                        'rgba(25,135,84,1)',
                        'rgba(220,53,69,1)',
                        'rgba(13,110,253,0.8)',
                        'rgba(108,117,125,1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { color: legendColor } }
                },
                cutout: '60%'
            }
        });
    }
});
</script>
{% endblock extra_js %}
