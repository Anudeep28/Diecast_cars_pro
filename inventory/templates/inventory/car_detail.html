{% extends 'inventory/base.html' %}

{% block title %}{{ car.model_name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h2>{{ car.model_name }}</h2>
                <h5 class="text-muted">{{ car.manufacturer }} <span class="badge bg-secondary">Scale {{ car.scale }}</span></h5>
            </div>
            {% if car.image %}
            <div class="text-center p-3">
                <img src="{{ car.image.url }}" alt="{{ car.model_name }}" class="img-fluid rounded" style="max-height: 300px;">
            </div>
            {% endif %}
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h4>Item Details</h4>
                        <table class="table">
                            <tr>
                                <th>Price:</th>
                                <td>₹{{ car.price }}</td>
                            </tr>
                            <tr>
                                <th>Shipping Cost:</th>
                                <td>₹{{ car.shipping_cost }}</td>
                            </tr>
                            <tr>
                                <th>Advance Payment:</th>
                                <td>₹{{ car.advance_payment }}</td>
                            </tr>
                            <tr>
                                <th>Remaining Payment:</th>
                                <td>₹{{ car.remaining_payment }}</td>
                            </tr>
                            <tr>
                                <th>Purchase Date:</th>
                                <td>{{ car.purchase_date }}</td>
                            </tr>
                            <tr>
                                <th>Delivery Due Date:</th>
                                <td>{{ car.delivery_due_date }}</td>
                            </tr>
                            <tr>
                                <th>Delivered Date:</th>
                                <td>{% if car.delivered_date %}{{ car.delivered_date }}{% else %}<span class="text-muted">Not delivered yet</span>{% endif %}
                            </tr>
                            <tr>
                                <th>Tracking ID:</th>
                                <td>{% if car.tracking_id %}{{ car.tracking_id }}{% else %}<span class="text-muted">Not available</span>{% endif %}</td>
                            </tr>
                            <tr>
                                <th>Delivery Service:</th>
                                <td>{% if car.delivery_service %}{{ car.delivery_service }}{% else %}<span class="text-muted">Not specified</span>{% endif %}</td>
                            </tr>
                            <tr>
                                <th>Status:</th>
                                <td>
                                    <span class="badge {% if car.status == 'Purchased/Paid' %}bg-info{% elif car.status == 'Shipped' %}bg-warning{% elif car.status == 'Delivered' %}bg-success{% else %}bg-danger{% endif %} rounded-pill">
                                        {{ car.status }}
                                    </span>
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h4>Seller Information</h4>
                        <div class="border p-3 rounded">
                            {{ car.seller_info|linebreaks }}
                            
                            {% if car.facebook_page %}
                            <hr>
                            <p>
                                <strong>Facebook Page:</strong> 
                                <a href="{% if 'http' in car.facebook_page %}{{ car.facebook_page }}{% elif '@' in car.facebook_page %}https://www.facebook.com/{{ car.facebook_page|cut:'@' }}{% else %}https://www.facebook.com/{{ car.facebook_page }}{% endif %}" target="_blank" class="text-primary">
                                    {{ car.facebook_page }}
                                    <i class="fas fa-external-link-alt"></i>
                                </a>
                            </p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                {% if car.status == 'Delivered' and car.packaging_quality and car.product_quality %}
                <div class="mt-4">
                    <h4>Your Feedback</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Packaging Quality:</strong> 
                                {% for i in "12345" %}
                                    {% if forloop.counter <= car.packaging_quality %}
                                    <i class="fas fa-star text-warning"></i>
                                    {% else %}
                                    <i class="far fa-star"></i>
                                    {% endif %}
                                {% endfor %}
                                ({{ car.packaging_quality }}/5)
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Product Quality:</strong> 
                                {% for i in "12345" %}
                                    {% if forloop.counter <= car.product_quality %}
                                    <i class="fas fa-star text-warning"></i>
                                    {% else %}
                                    <i class="far fa-star"></i>
                                    {% endif %}
                                {% endfor %}
                                ({{ car.product_quality }}/5)
                            </p>
                        </div>
                    </div>
                    {% if car.feedback_notes %}
                    <div class="border p-3 rounded bg-light">
                        <h5>Notes:</h5>
                        {{ car.feedback_notes|linebreaks }}
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                <div class="mt-4">
                    <a href="{% url 'dashboard' %}" class="btn btn-secondary">Back to Dashboard</a>
                    <a href="{% url 'car_update' car.pk %}" class="btn btn-primary">Edit</a>
                    <a href="{% url 'car_delete' car.pk %}" class="btn btn-danger">Delete</a>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Market Data -->
        <div class="card mb-4">
            <div class="card-header">
                <h4>Market Value</h4>
            </div>
            <div class="card-body">
                <button id="fetch-market-price-btn" class="btn btn-primary w-100">Fetch Market Value</button>
                <div id="market-price-result" class="mt-3" style="display: none;">
                    <h4>Market Analysis</h4>
                    <p><strong>Average Price:</strong> <span id="average-price"></span></p>
                    <p class="mb-2"><strong>Vs Purchase:</strong> <span id="vs-purchase"></span></p>
                    <h5>Source Quotes:</h5>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Website</th>
                                    <th>Price</th>
                                    <th>Seller</th>
                                    <th>Title</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="quotes-list">
                            </tbody>
                        </table>
                    </div>
                </div>
                <div id="market-price-loading" class="mt-3 text-center" style="display: none;">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Fetching data...</p>
                </div>
                <div id="market-price-error" class="alert alert-danger mt-3" style="display: none;"></div>
            </div>
        </div>

        <!-- Marketplace Links -->
        {% if market_links %}
        <div class="card mb-4">
            <div class="card-header">
                <h5>Marketplace Links</h5>
            </div>
            <div class="card-body">
                <ul class="mb-0">
                    {% for link in market_links %}
                    <li>
                        <span class="badge bg-secondary">{{ link.get_marketplace_display }}</span>
                        {% if link.url %}
                            <a href="{{ link.url }}" target="_blank" rel="noopener">{{ link.external_id }}</a>
                        {% else %}
                            {{ link.external_id }}
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% endif %}

        <!-- Latest Market Summary -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>Latest Market Summary</h5>
            </div>
            <div class="card-body">
                <p class="mb-1"><strong>Average Price:</strong> <span id="latest-avg-price">{% if latest_avg_price %}₹{{ latest_avg_price|floatformat:2 }}{% else %}Not available{% endif %}</span></p>
                <p class="mb-0"><strong>Vs Purchase:</strong> <span id="latest-vs-purchase">{% if pct_vs_purchase is not None %}{% if pct_vs_purchase >= 0 %}+{% endif %}{{ pct_vs_purchase }}%{% else %}N/A{% endif %}</span></p>
            </div>
        </div>

        <!-- Price History -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>Recent Market History</h5>
            </div>
            <div class="card-body p-0">
                <table class="table table-sm mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="small">Date</th>
                            <th class="small">Marketplace</th>
                            <th class="text-end small">Price</th>
                        </tr>
                    </thead>
                    <tbody id="price-history-body">
                        {% if price_history %}
                            {% for mp in price_history %}
                            <tr>
                                <td class="small">{{ mp.fetched_at|date:'Y-m-d H:i' }}</td>
                                <td class="small">{{ mp.get_marketplace_display }}</td>
                                <td class="text-end">₹{{ mp.price }}</td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr data-placeholder="true">
                                <td colspan="3" class="text-center text-muted small">No market history yet.</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>


        <div class="card">
            <div class="card-header">
                <h4>Update Status</h4>
            </div>
            <div class="card-body">
                <form method="post" action="{% url 'update_status' car.pk %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="status" class="form-label">Current Status:</label>
                        <select class="form-select" id="status" name="status">
                            {% for status_value, status_label in car.STATUS_CHOICES %}
                            <option value="{{ status_value }}" {% if car.status == status_value %}selected{% endif %}>{{ status_label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-success">Update Status</button>
                    </div>
                </form>
            </div>
        </div>

        {% if car.status == 'Delivered' and not car.packaging_quality %}
        <div class="card mt-4">
            <div class="card-header">
                <h4>Add Feedback</h4>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="packaging_quality" class="form-label">Packaging Quality:</label>
                        <select class="form-select" id="packaging_quality" name="packaging_quality">
                            <option value="">Select Rating</option>
                            <option value="1">1 - Poor</option>
                            <option value="2">2 - Fair</option>
                            <option value="3">3 - Good</option>
                            <option value="4">4 - Very Good</option>
                            <option value="5">5 - Excellent</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="product_quality" class="form-label">Product Quality:</label>
                        <select class="form-select" id="product_quality" name="product_quality">
                            <option value="">Select Rating</option>
                            <option value="1">1 - Poor</option>
                            <option value="2">2 - Fair</option>
                            <option value="3">3 - Good</option>
                            <option value="4">4 - Very Good</option>
                            <option value="5">5 - Excellent</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="feedback_notes" class="form-label">Notes:</label>
                        <textarea class="form-control" id="feedback_notes" name="feedback_notes" rows="3"></textarea>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Submit Feedback</button>
                    </div>
                </form>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.getElementById('fetch-market-price-btn').addEventListener('click', function() {
        const carId = Number("{{ car.pk }}");
        const resultDiv = document.getElementById('market-price-result');
        const loadingDiv = document.getElementById('market-price-loading');
        const errorDiv = document.getElementById('market-price-error');
        const avgPriceSpan = document.getElementById('average-price');
        const vsPurchaseSpan = document.getElementById('vs-purchase');
        const quotesList = document.getElementById('quotes-list');
        const historyBody = document.getElementById('price-history-body');
        const latestAvgSpan = document.getElementById('latest-avg-price');
        const latestVsPurchaseSpan = document.getElementById('latest-vs-purchase');

        const sourceDisplay = {
            'web': 'Web Search',
            'hobbydb': 'hobbyDB',
            'diecast_auction': 'Diecast Auction',
            'facebook': 'Facebook',
            'ebay': 'eBay'
        };

        function formatDate(isoStr) {
            try {
                const d = isoStr ? new Date(isoStr) : new Date();
                const pad = n => String(n).padStart(2, '0');
                const y = d.getFullYear();
                const m = pad(d.getMonth() + 1);
                const day = pad(d.getDate());
                const h = pad(d.getHours());
                const min = pad(d.getMinutes());
                return `${y}-${m}-${day} ${h}:${min}`;
            } catch (e) {
                return isoStr || '';
            }
        }

        // Show loading indicator
        loadingDiv.style.display = 'block';
        resultDiv.style.display = 'none';
        errorDiv.style.display = 'none';

        fetch(`/api/car/${carId}/fetch_market_price/`)
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text || 'Network response was not ok') });
                }
                return response.json();
            })
            .then(data => {
                loadingDiv.style.display = 'none';

                if (data.average_price_inr) {
                    avgPriceSpan.textContent = `₹${data.average_price_inr}`;
                } else {
                    avgPriceSpan.textContent = 'Not available';
                }

                // Vs Purchase
                if (typeof data.percent_change_from_purchase !== 'undefined' && data.percent_change_from_purchase !== null) {
                    const val = parseFloat(data.percent_change_from_purchase);
                    if (!isNaN(val)) {
                        const sign = val >= 0 ? '+' : '';
                        vsPurchaseSpan.textContent = `${sign}${val}%`;
                        // also update the summary card
                        if (latestVsPurchaseSpan) latestVsPurchaseSpan.textContent = `${sign}${val}%`;
                    } else {
                        vsPurchaseSpan.textContent = 'N/A';
                        if (latestVsPurchaseSpan) latestVsPurchaseSpan.textContent = 'N/A';
                    }
                } else {
                    vsPurchaseSpan.textContent = 'N/A';
                    if (latestVsPurchaseSpan) latestVsPurchaseSpan.textContent = 'N/A';
                }

                quotesList.innerHTML = '';
                if (data.quotes && data.quotes.length > 0) {
                    data.quotes.forEach(quote => {
                        const row = document.createElement('tr');
                        
                        // Website cell
                        const websiteCell = document.createElement('td');
                        if (quote.source_listing_url) {
                            try {
                                const urlObj = new URL(quote.source_listing_url);
                                let domain = urlObj.hostname.replace('www.', '');
                                if (domain.length > 15) {
                                    domain = domain.substring(0, 12) + '...';
                                }
                                websiteCell.innerHTML = `<a href="${quote.source_listing_url}" target="_blank" class="text-primary">${domain}</a>`;
                            } catch (e) {
                                console.error('Error parsing URL:', e, quote.source_listing_url);
                                websiteCell.textContent = 'Invalid URL';
                            }
                        } else {
                            websiteCell.textContent = 'No URL';
                        }
                        
                        // Price cell
                        const priceCell = document.createElement('td');
                        if (quote.price_inr) {
                            priceCell.innerHTML = `<strong>₹${quote.price_inr}</strong>`;
                        } else if (quote.original_price && quote.original_currency) {
                            priceCell.innerHTML = `<strong>${quote.original_price} ${quote.original_currency}</strong>`;
                        } else {
                            priceCell.textContent = 'N/A';
                        }
                        
                        // Seller cell
                        const sellerCell = document.createElement('td');
                        sellerCell.textContent = quote.seller || 'N/A';
                        
                        // Title cell
                        const titleCell = document.createElement('td');
                        let title = quote.title || 'No title';
                        if (title.length > 40) {
                            title = title.substring(0, 37) + '...';
                        }
                        titleCell.textContent = title;
                        titleCell.style.fontSize = '0.85em';
                        
                        // Actions cell
                        const actionsCell = document.createElement('td');
                        if (quote.source_listing_url) {
                            actionsCell.innerHTML = `<a href="${quote.source_listing_url}" target="_blank" class="btn btn-sm btn-outline-primary">View</a>`;
                        } else {
                            actionsCell.textContent = 'N/A';
                        }
                        
                        row.appendChild(websiteCell);
                        row.appendChild(priceCell);
                        row.appendChild(sellerCell);
                        row.appendChild(titleCell);
                        row.appendChild(actionsCell);
                        
                        quotesList.appendChild(row);
                    });
                } else {
                    const emptyRow = document.createElement('tr');
                    const td = document.createElement('td');
                    td.colSpan = 5;
                    td.className = 'text-center text-muted';
                    td.textContent = 'No quotes found.';
                    emptyRow.appendChild(td);
                    quotesList.appendChild(emptyRow);
                }

                resultDiv.style.display = 'block';

                // Update Latest Market Summary (average)
                if (latestAvgSpan) {
                    if (data.average_price_inr) {
                        latestAvgSpan.textContent = `₹${data.average_price_inr}`;
                    } else {
                        latestAvgSpan.textContent = 'Not available';
                    }
                }

                // Dynamically update Recent Market History with new quotes
                if (historyBody && data.quotes && data.quotes.length > 0) {
                    const placeholder = historyBody.querySelector('tr[data-placeholder="true"]');
                    if (placeholder) placeholder.remove();

                    data.quotes.forEach(quote => {
                        const tr = document.createElement('tr');
                        const dateTd = document.createElement('td');
                        dateTd.className = 'small';
                        dateTd.textContent = formatDate(quote.fetched_at);
                        const marketTd = document.createElement('td');
                        marketTd.className = 'small';
                        marketTd.textContent = sourceDisplay[quote.source] || (quote.source || '—');
                        const priceTd = document.createElement('td');
                        priceTd.className = 'text-end';
                        if (quote.price_inr) {
                            priceTd.textContent = `₹${quote.price_inr}`;
                        } else if (quote.original_price && quote.original_currency) {
                            priceTd.textContent = `${quote.original_price} ${quote.original_currency}`;
                        } else {
                            priceTd.textContent = 'N/A';
                        }
                        tr.appendChild(dateTd);
                        tr.appendChild(marketTd);
                        tr.appendChild(priceTd);
                        historyBody.insertBefore(tr, historyBody.firstChild);
                    });

                    // Trim to 10 rows
                    while (historyBody.children.length > 10) {
                        historyBody.removeChild(historyBody.lastChild);
                    }
                }
            })
            .catch(error => {
                loadingDiv.style.display = 'none';
                errorDiv.textContent = 'Error fetching market price: ' + error.message;
                errorDiv.style.display = 'block';
            });
    });
</script>
{% endblock %}
