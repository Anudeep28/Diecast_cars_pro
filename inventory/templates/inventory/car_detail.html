{% extends 'inventory/base.html' %}

{% block title %}{{ car.model_name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h2>{{ car.model_name }}</h2>
                <h5 class="text-muted">{{ car.manufacturer }} <span class="badge bg-secondary">Scale {{ car.scale }}</span></h5>
            </div>
            {% if car.image %}
            <div class="text-center p-3">
                <img src="{{ car.image.url }}" alt="{{ car.model_name }}" class="img-fluid rounded img-max-h-300">
            </div>
            {% endif %}
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h4>Item Details</h4>
                        <table class="table">
                            <tr>
                                <th>Price:</th>
                                <td>₹{{ car.price }}</td>
                            </tr>
                            <tr>
                                <th>Shipping Cost:</th>
                                <td>₹{{ car.shipping_cost }}</td>
                            </tr>
                            <tr>
                                <th>Advance Payment:</th>
                                <td>₹{{ car.advance_payment }}</td>
                            </tr>
                            <tr>
                                <th>Remaining Payment:</th>
                                <td>₹{{ car.remaining_payment }}</td>
                            </tr>
                            <tr>
                                <th>Purchase Date:</th>
                                <td>{{ car.purchase_date }}</td>
                            </tr>
                            <tr>
                                <th>Delivery Due Date:</th>
                                <td>{{ car.delivery_due_date }}</td>
                            </tr>
                            <tr>
                                <th>Delivered Date:</th>
                                <td>{% if car.delivered_date %}{{ car.delivered_date }}{% else %}<span class="text-muted">Not delivered yet</span>{% endif %}
                            </tr>
                            <tr>
                                <th>Tracking ID:</th>
                                <td>{% if car.tracking_id %}{{ car.tracking_id }}{% else %}<span class="text-muted">Not available</span>{% endif %}</td>
                            </tr>
                            <tr>
                                <th>Delivery Service:</th>
                                <td>{% if car.delivery_service %}{{ car.delivery_service }}{% else %}<span class="text-muted">Not specified</span>{% endif %}</td>
                            </tr>
                            <tr>
                                <th>Status:</th>
                                <td>
                                    <span class="badge {% if car.status == 'Purchased/Paid' %}bg-info{% elif car.status == 'Shipped' %}bg-warning{% elif car.status == 'Delivered' %}bg-success{% else %}bg-danger{% endif %} rounded-pill">
                                        {{ car.status }}
                                    </span>
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h4>Seller Information</h4>
                        <div class="border p-3 rounded">
                            {{ car.seller_info|linebreaks }}
                            
                            {% if car.facebook_page %}
                            <hr>
                            <p>
                                <strong>Facebook Page:</strong> 
                                <a href="{% if 'http' in car.facebook_page %}{{ car.facebook_page }}{% elif '@' in car.facebook_page %}https://www.facebook.com/{{ car.facebook_page|cut:'@' }}{% else %}https://www.facebook.com/{{ car.facebook_page }}{% endif %}" target="_blank" class="text-primary">
                                    {{ car.facebook_page }}
                                    <i class="fas fa-external-link-alt"></i>
                                </a>
                            </p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                {% if car.status == 'Delivered' and car.packaging_quality and car.product_quality %}
                <div class="mt-4">
                    <h4>Your Feedback</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Packaging Quality:</strong> 
                                {% for i in "12345" %}
                                    {% if forloop.counter <= car.packaging_quality %}
                                    <i class="fas fa-star text-warning"></i>
                                    {% else %}
                                    <i class="far fa-star"></i>
                                    {% endif %}
                                {% endfor %}
                                ({{ car.packaging_quality }}/5)
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Product Quality:</strong> 
                                {% for i in "12345" %}
                                    {% if forloop.counter <= car.product_quality %}
                                    <i class="fas fa-star text-warning"></i>
                                    {% else %}
                                    <i class="far fa-star"></i>
                                    {% endif %}
                                {% endfor %}
                                ({{ car.product_quality }}/5)
                            </p>
                        </div>
                    </div>
                    {% if car.feedback_notes %}
                    <div class="border p-3 rounded bg-light">
                        <h5>Notes:</h5>
                        {{ car.feedback_notes|linebreaks }}
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                <div class="mt-4">
                    <a href="{% url 'dashboard' %}" class="btn btn-secondary">Back to Dashboard</a>
                    <a href="{% url 'car_update' car.pk %}" class="btn btn-primary">Edit</a>
                    <a href="{% url 'car_delete' car.pk %}" class="btn btn-danger">Delete</a>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Market Data -->
        <div class="card mb-4">
            <div class="card-header">
                <h4>Market Value</h4>
            </div>
            <div class="card-body">
                <button id="fetch-market-price-btn" class="btn btn-primary w-100">Fetch Market Value</button>
                <div id="market-price-result" class="mt-3 d-none">
                    <h4>Market Analysis</h4>
                    <p><strong>Average Price:</strong> <span id="average-price"></span></p>
                    <p class="mb-2"><strong>Vs Purchase:</strong> <span id="vs-purchase"></span></p>
                    <h5>Source Quotes:</h5>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Website</th>
                                    <th>Price</th>
                                    <th>Seller</th>
                                    <th>Title</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="quotes-list">
                            </tbody>
                        </table>
                    </div>
                </div>
                <div id="market-price-loading" class="mt-3 text-center d-none">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Fetching data...</p>
                </div>
                <div id="market-price-error" class="alert alert-danger mt-3 d-none"></div>
                
                <!-- Manual Add Quote UI -->
                <button class="btn btn-outline-secondary w-100 mt-2" type="button" data-bs-toggle="collapse" data-bs-target="#manual-quote-collapse" aria-expanded="false" aria-controls="manual-quote-collapse">
                    Add Manual Quote
                </button>
                <div class="collapse mt-3" id="manual-quote-collapse">
                    <div class="card card-body p-3">
                        <div id="manual-quote-feedback" class="mt-1 d-none"></div>
                        <div class="row g-2">
                            <div class="col-6">
                                <label for="manual-marketplace" class="form-label">Marketplace</label>
                                <select id="manual-marketplace" class="form-select">
                                    <option value="">Select</option>
                                    <option value="web">Web Search</option>
                                    <option value="hobbydb">hobbyDB</option>
                                    <option value="diecast_auction">Diecast Auction</option>
                                    <option value="facebook">Facebook</option>
                                    <option value="ebay">eBay</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label for="manual-price" class="form-label">Price</label>
                                <input id="manual-price" type="number" class="form-control" placeholder="Amount" step="0.01" min="0">
                            </div>
                            <div class="col-6">
                                <label for="manual-currency" class="form-label">Currency</label>
                                <select id="manual-currency" class="form-select">
                                    <option value="INR" selected>INR</option>
                                    <option value="USD">USD</option>
                                    <option value="EUR">EUR</option>
                                    <option value="GBP">GBP</option>
                                    <option value="JPY">JPY</option>
                                    <option value="CAD">CAD</option>
                                    <option value="AUD">AUD</option>
                                    <option value="SGD">SGD</option>
                                    <option value="MYR">MYR</option>
                                    <option value="CNY">CNY</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label for="manual-seller" class="form-label">Seller</label>
                                <input id="manual-seller" type="text" class="form-control" placeholder="Seller name (optional)">
                            </div>
                            <div class="col-12">
                                <label for="manual-title" class="form-label">Title</label>
                                <input id="manual-title" type="text" class="form-control" placeholder="Listing title (optional)">
                            </div>
                            <div class="col-12">
                                <label for="manual-url" class="form-label">Source URL</label>
                                <input id="manual-url" type="url" class="form-control" placeholder="https://example.com/listing (optional)">
                            </div>
                        </div>
                        <div class="d-grid mt-3">
                            <button id="manual-submit-btn" class="btn btn-success">Add Quote</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Marketplace Links -->
        {% if market_links %}
        <div class="card mb-4">
            <div class="card-header">
                <h5>Marketplace Links</h5>
            </div>
            <div class="card-body">
                <ul class="mb-0">
                    {% for link in market_links %}
                    <li>
                        <span class="badge bg-secondary">{{ link.get_marketplace_display }}</span>
                        {% if link.url %}
                            <a href="{{ link.url }}" target="_blank" rel="noopener">{{ link.external_id }}</a>
                        {% else %}
                            {{ link.external_id }}
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% endif %}

        <!-- Latest Market Summary -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>Latest Market Summary</h5>
            </div>
            <div class="card-body">
                <p class="mb-1"><strong>Average Price:</strong> <span id="latest-avg-price">{% if latest_avg_price %}₹{{ latest_avg_price|floatformat:2 }}{% else %}Not available{% endif %}</span></p>
                <p class="mb-0"><strong>Vs Purchase:</strong> <span id="latest-vs-purchase">{% if pct_vs_purchase is not None %}{% if pct_vs_purchase >= 0 %}+{% endif %}{{ pct_vs_purchase }}%{% else %}N/A{% endif %}</span></p>
            </div>
        </div>

        <!-- Price History -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>Recent Market History</h5>
            </div>
            <div class="card-body p-0">
                <table class="table table-sm mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="small">Date</th>
                            <th class="small">Marketplace</th>
                            <th class="text-end small">Price</th>
                        </tr>
                    </thead>
                    <tbody id="price-history-body">
                        {% if price_history %}
                            {% for mp in price_history %}
                            <tr>
                                <td class="small">{{ mp.fetched_at|date:'Y-m-d H:i' }}</td>
                                <td class="small">{{ mp.get_marketplace_display }}</td>
                                <td class="text-end">₹{{ mp.price }}</td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr data-placeholder="true">
                                <td colspan="3" class="text-center text-muted small">No market history yet.</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>


        <div class="card">
            <div class="card-header">
                <h4>Update Status</h4>
            </div>
            <div class="card-body">
                <form method="post" action="{% url 'update_status' car.pk %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="status" class="form-label">Current Status:</label>
                        <select class="form-select" id="status" name="status">
                            {% for status_value, status_label in car.STATUS_CHOICES %}
                            <option value="{{ status_value }}" {% if car.status == status_value %}selected{% endif %}>{{ status_label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-success">Update Status</button>
                    </div>
                </form>
            </div>
        </div>

        {% if car.status == 'Delivered' and not car.packaging_quality %}
        <div class="card mt-4">
            <div class="card-header">
                <h4>Add Feedback</h4>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="packaging_quality" class="form-label">Packaging Quality:</label>
                        <select class="form-select" id="packaging_quality" name="packaging_quality">
                            <option value="">Select Rating</option>
                            <option value="1">1 - Poor</option>
                            <option value="2">2 - Fair</option>
                            <option value="3">3 - Good</option>
                            <option value="4">4 - Very Good</option>
                            <option value="5">5 - Excellent</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="product_quality" class="form-label">Product Quality:</label>
                        <select class="form-select" id="product_quality" name="product_quality">
                            <option value="">Select Rating</option>
                            <option value="1">1 - Poor</option>
                            <option value="2">2 - Fair</option>
                            <option value="3">3 - Good</option>
                            <option value="4">4 - Very Good</option>
                            <option value="5">5 - Excellent</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="feedback_notes" class="form-label">Notes:</label>
                        <textarea class="form-control" id="feedback_notes" name="feedback_notes" rows="3"></textarea>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Submit Feedback</button>
                    </div>
                </form>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Helpers and global handlers
    const carIdGlobal = Number("{{ car.pk }}");
    const purchasePriceInrGlobal = (function() {
        const v = parseFloat("{{ car.price }}");
        return isNaN(v) ? 0 : v;
    })();

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function sourceLabel(src) {
        const map = {
            'web': 'Web Search',
            'hobbydb': 'hobbyDB',
            'diecast_auction': 'Diecast Auction',
            'facebook': 'Facebook',
            'ebay': 'eBay'
        };
        return map[src] || (src || '—');
    }

    function createQuoteRow(quote) {
        const row = document.createElement('tr');
        if (quote && quote.id) {
            row.dataset.quoteId = quote.id;
        }
        if (quote && quote.price_inr) {
            const p = parseFloat(quote.price_inr);
            if (!isNaN(p)) row.dataset.priceInr = p;
        }

        // Website cell
        const websiteCell = document.createElement('td');
        if (quote && quote.source_listing_url) {
            try {
                const urlObj = new URL(quote.source_listing_url);
                let domain = urlObj.hostname.replace('www.', '');
                if (domain.length > 15) domain = domain.substring(0, 12) + '...';
                websiteCell.innerHTML = `<a href="${quote.source_listing_url}" target="_blank" class="text-primary">${domain}</a>`;
            } catch (e) {
                websiteCell.textContent = 'Invalid URL';
            }
        } else {
            websiteCell.textContent = 'No URL';
        }

        // Price cell
        const priceCell = document.createElement('td');
        if (quote && quote.price_inr) {
            priceCell.innerHTML = `<strong>₹${quote.price_inr}</strong>`;
        } else if (quote && quote.original_price && quote.original_currency) {
            priceCell.innerHTML = `<strong>${quote.original_price} ${quote.original_currency}</strong>`;
        } else {
            priceCell.textContent = 'N/A';
        }

        // Seller cell
        const sellerCell = document.createElement('td');
        sellerCell.textContent = (quote && quote.seller) ? quote.seller : 'N/A';

        // Title cell
        const titleCell = document.createElement('td');
        let title = (quote && quote.title) ? quote.title : 'No title';
        if (title.length > 40) title = title.substring(0, 37) + '...';
        titleCell.textContent = title;
        titleCell.classList.add('small');

        // Actions cell
        const actionsCell = document.createElement('td');
        const parts = [];
        if (quote && quote.source_listing_url) {
            parts.push(`<a href="${quote.source_listing_url}" target="_blank" class="btn btn-sm btn-outline-primary">View</a>`);
        }
        if (quote && quote.id) {
            parts.push(`<button type="button" class="btn btn-sm btn-outline-danger ms-1 btn-delete-quote" data-quote-id="${quote.id}">Delete</button>`);
        }
        actionsCell.innerHTML = parts.length ? parts.join(' ') : 'N/A';

        row.appendChild(websiteCell);
        row.appendChild(priceCell);
        row.appendChild(sellerCell);
        row.appendChild(titleCell);
        row.appendChild(actionsCell);
        return row;
    }

    function recalcSummaryFromQuotes() {
        try {
            const rows = Array.from(document.querySelectorAll('#quotes-list tr'));
            let sum = 0.0, cnt = 0;
            rows.forEach(r => {
                const v = parseFloat(r.dataset.priceInr);
                if (!isNaN(v) && v > 0) { sum += v; cnt += 1; }
            });
            const avg = cnt > 0 ? (sum / cnt) : 0;
            const avgStr = avg > 0 ? `₹${avg.toFixed(2)}` : 'Not available';
            const avgSpan = document.getElementById('average-price');
            if (avgSpan) avgSpan.textContent = avgStr;
            const latestAvgSpan = document.getElementById('latest-avg-price');
            if (latestAvgSpan) latestAvgSpan.textContent = avg > 0 ? `₹${avg.toFixed(2)}` : 'Not available';

            const vsSpan = document.getElementById('vs-purchase');
            const latestVsSpan = document.getElementById('latest-vs-purchase');
            if (purchasePriceInrGlobal > 0 && avg > 0) {
                const pct = ((avg - purchasePriceInrGlobal) / purchasePriceInrGlobal) * 100;
                const sign = pct >= 0 ? '+' : '';
                const txt = `${sign}${pct.toFixed(2)}%`;
                if (vsSpan) vsSpan.textContent = txt;
                if (latestVsSpan) latestVsSpan.textContent = txt;
            } else {
                if (vsSpan) vsSpan.textContent = 'N/A';
                if (latestVsSpan) latestVsSpan.textContent = 'N/A';
            }
        } catch (e) {
            // ignore
        }
    }

    function appendHistoryRow(quote) {
        try {
            const historyBody = document.getElementById('price-history-body');
            if (!historyBody) return;
            const placeholder = historyBody.querySelector('tr[data-placeholder="true"]');
            if (placeholder) placeholder.remove();
            const tr = document.createElement('tr');
            const dateTd = document.createElement('td');
            dateTd.className = 'small';
            const iso = quote && quote.fetched_at ? quote.fetched_at : new Date().toISOString();
            const d = new Date(iso);
            const pad = n => String(n).padStart(2, '0');
            dateTd.textContent = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
            const marketTd = document.createElement('td');
            marketTd.className = 'small';
            marketTd.textContent = sourceLabel((quote && (quote.source || quote.marketplace)) || '');
            const priceTd = document.createElement('td');
            priceTd.className = 'text-end';
            if (quote && quote.price_inr) priceTd.textContent = `₹${quote.price_inr}`;
            else if (quote && quote.original_price && quote.original_currency) priceTd.textContent = `${quote.original_price} ${quote.original_currency}`;
            else priceTd.textContent = 'N/A';
            tr.appendChild(dateTd);
            tr.appendChild(marketTd);
            tr.appendChild(priceTd);
            historyBody.insertBefore(tr, historyBody.firstChild);
            while (historyBody.children.length > 10) {
                historyBody.removeChild(historyBody.lastChild);
            }
        } catch (e) {
            // ignore
        }
    }

    // Delete handler (event delegation)
    document.getElementById('quotes-list').addEventListener('click', function(e) {
        const btn = e.target.closest('.btn-delete-quote');
        if (!btn) return;
        const priceId = btn.getAttribute('data-quote-id');
        if (!priceId) return;
        if (!confirm('Are you sure you want to delete this quote?')) return;
        btn.disabled = true;
        fetch(`/api/market_price/${priceId}/`, {
            method: 'DELETE',
            headers: { 'X-CSRFToken': getCookie('csrftoken') },
        }).then(resp => {
            if (!resp.ok) return resp.text().then(t => { throw new Error(t || 'Delete failed'); });
            return resp.json();
        }).then(() => {
            const row = btn.closest('tr');
            if (row) row.remove();
            // If table empty, add placeholder row
            const list = document.getElementById('quotes-list');
            if (list && list.children.length === 0) {
                const emptyRow = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = 5;
                td.className = 'text-center text-muted';
                td.textContent = 'No quotes found.';
                emptyRow.appendChild(td);
                list.appendChild(emptyRow);
            }
            recalcSummaryFromQuotes();
        }).catch(err => {
            alert('Error: ' + err.message);
        }).finally(() => {
            btn.disabled = false;
        });
    });

    // Manual add handler
    document.getElementById('manual-submit-btn').addEventListener('click', function() {
        const fb = document.getElementById('manual-quote-feedback');
        const marketplace = (document.getElementById('manual-marketplace').value || '').trim();
        const priceStr = (document.getElementById('manual-price').value || '').trim();
        const currency = (document.getElementById('manual-currency').value || 'INR').trim();
        const title = (document.getElementById('manual-title').value || '').trim();
        const url = (document.getElementById('manual-url').value || '').trim();
        const seller = (document.getElementById('manual-seller').value || '').trim();

        fb.textContent = '';
        fb.classList.add('d-none');
        fb.classList.remove('alert', 'alert-warning', 'alert-success', 'alert-danger');

        const price = parseFloat(priceStr);
        if (!marketplace) {
            fb.textContent = 'Please select a marketplace.';
            fb.classList.add('alert', 'alert-warning');
            fb.classList.remove('d-none');
            return;
        }
        if (isNaN(price) || price <= 0) {
            fb.textContent = 'Please enter a valid positive price.';
            fb.classList.add('alert', 'alert-warning');
            fb.classList.remove('d-none');
            return;
        }

        const btn = document.getElementById('manual-submit-btn');
        btn.disabled = true;

        fetch(`/api/car/${carIdGlobal}/market_price/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                marketplace: marketplace,
                price: price,
                currency: currency,
                title: title || null,
                source_listing_url: url || null,
                seller: seller || null
            })
        }).then(resp => {
            if (!resp.ok) return resp.text().then(t => { throw new Error(t || 'Failed to add quote'); });
            return resp.json();
        }).then(data => {
            if (!data || !data.success || !data.quote) throw new Error('Invalid server response');
            // Ensure result visible
            const resultDiv = document.getElementById('market-price-result');
            if (resultDiv) resultDiv.classList.remove('d-none');
            // Remove placeholder if present and append row
            const list = document.getElementById('quotes-list');
            if (list) {
                const placeholder = list.querySelector('tr td.text-center');
                if (placeholder && placeholder.parentElement && list.children.length === 1) {
                    placeholder.parentElement.remove();
                }
                const row = createQuoteRow(data.quote);
                list.appendChild(row);
            }
            // Update summary and history
            recalcSummaryFromQuotes();
            appendHistoryRow(data.quote);
            
            fb.textContent = 'Quote added successfully.';
            fb.classList.add('alert', 'alert-success');
            fb.classList.remove('d-none');
        }).catch(err => {
            fb.textContent = 'Error: ' + err.message;
            fb.classList.add('alert', 'alert-danger');
            fb.classList.remove('d-none');
        }).finally(() => {
            btn.disabled = false;
        });
    });

    // Existing fetch handler
    document.getElementById('fetch-market-price-btn').addEventListener('click', function() {
        const carId = Number("{{ car.pk }}");
        const resultDiv = document.getElementById('market-price-result');
        const loadingDiv = document.getElementById('market-price-loading');
        const errorDiv = document.getElementById('market-price-error');
        const avgPriceSpan = document.getElementById('average-price');
        const vsPurchaseSpan = document.getElementById('vs-purchase');
        const quotesList = document.getElementById('quotes-list');
        const historyBody = document.getElementById('price-history-body');
        const latestAvgSpan = document.getElementById('latest-avg-price');
        const latestVsPurchaseSpan = document.getElementById('latest-vs-purchase');

        const sourceDisplay = {
            'web': 'Web Search',
            'hobbydb': 'hobbyDB',
            'diecast_auction': 'Diecast Auction',
            'facebook': 'Facebook',
            'ebay': 'eBay'
        };

        function formatDate(isoStr) {
            try {
                const d = isoStr ? new Date(isoStr) : new Date();
                const pad = n => String(n).padStart(2, '0');
                const y = d.getFullYear();
                const m = pad(d.getMonth() + 1);
                const day = pad(d.getDate());
                const h = pad(d.getHours());
                const min = pad(d.getMinutes());
                return `${y}-${m}-${day} ${h}:${min}`;
            } catch (e) {
                return isoStr || '';
            }
        }

        // Show loading indicator
        loadingDiv.classList.remove('d-none');
        resultDiv.classList.add('d-none');
        errorDiv.classList.add('d-none');

        fetch(`/api/car/${carId}/fetch_market_price/`)
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text || 'Network response was not ok') });
                }
                return response.json();
            })
            .then(data => {
                loadingDiv.classList.add('d-none');

                if (data.average_price_inr) {
                    avgPriceSpan.textContent = `₹${data.average_price_inr}`;
                } else {
                    avgPriceSpan.textContent = 'Not available';
                }

                // Vs Purchase
                if (typeof data.percent_change_from_purchase !== 'undefined' && data.percent_change_from_purchase !== null) {
                    const val = parseFloat(data.percent_change_from_purchase);
                    if (!isNaN(val)) {
                        const sign = val >= 0 ? '+' : '';
                        vsPurchaseSpan.textContent = `${sign}${val}%`;
                        // also update the summary card
                        if (latestVsPurchaseSpan) latestVsPurchaseSpan.textContent = `${sign}${val}%`;
                    } else {
                        vsPurchaseSpan.textContent = 'N/A';
                        if (latestVsPurchaseSpan) latestVsPurchaseSpan.textContent = 'N/A';
                    }
                } else {
                    vsPurchaseSpan.textContent = 'N/A';
                    if (latestVsPurchaseSpan) latestVsPurchaseSpan.textContent = 'N/A';
                }

                quotesList.innerHTML = '';
                if (data.quotes && data.quotes.length > 0) {
                    data.quotes.forEach(quote => {
                        const row = createQuoteRow(quote);
                        quotesList.appendChild(row);
                    });
                } else {
                    const emptyRow = document.createElement('tr');
                    const td = document.createElement('td');
                    td.colSpan = 5;
                    td.className = 'text-center text-muted';
                    td.textContent = 'No quotes found.';
                    emptyRow.appendChild(td);
                    quotesList.appendChild(emptyRow);
                }

                resultDiv.classList.remove('d-none');

                // Update Latest Market Summary (average)
                if (latestAvgSpan) {
                    if (data.average_price_inr) {
                        latestAvgSpan.textContent = `₹${data.average_price_inr}`;
                    } else {
                        latestAvgSpan.textContent = 'Not available';
                    }
                }

                // Dynamically update Recent Market History with new quotes
                if (historyBody && data.quotes && data.quotes.length > 0) {
                    const placeholder = historyBody.querySelector('tr[data-placeholder="true"]');
                    if (placeholder) placeholder.remove();

                    data.quotes.forEach(quote => {
                        const tr = document.createElement('tr');
                        const dateTd = document.createElement('td');
                        dateTd.className = 'small';
                        dateTd.textContent = formatDate(quote.fetched_at);
                        const marketTd = document.createElement('td');
                        marketTd.className = 'small';
                        marketTd.textContent = sourceDisplay[quote.source] || (quote.source || '—');
                        const priceTd = document.createElement('td');
                        priceTd.className = 'text-end';
                        if (quote.price_inr) {
                            priceTd.textContent = `₹${quote.price_inr}`;
                        } else if (quote.original_price && quote.original_currency) {
                            priceTd.textContent = `${quote.original_price} ${quote.original_currency}`;
                        } else {
                            priceTd.textContent = 'N/A';
                        }
                        tr.appendChild(dateTd);
                        tr.appendChild(marketTd);
                        tr.appendChild(priceTd);
                        historyBody.insertBefore(tr, historyBody.firstChild);
                    });

                    // Trim to 10 rows
                    while (historyBody.children.length > 10) {
                        historyBody.removeChild(historyBody.lastChild);
                    }
                }
            })
            .catch(error => {
                loadingDiv.classList.add('d-none');
                errorDiv.textContent = 'Error fetching market price: ' + error.message;
                errorDiv.classList.remove('d-none');
            });
    });
</script>
{% endblock %}
